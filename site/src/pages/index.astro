---
import BaseHead from '../components/BaseHead.astro';
import SocialIcon from '../components/SocialIcon.astro';
import { fetchRss, sortByDate, type RssItem } from '../lib/rss';
import { LINKS, PROFILE, RSS_SOURCES } from '../site.config';

const pageTitle = `${PROFILE.name} | ${PROFILE.role}`;
const pageDescription = `${PROFILE.bio} GitHubやZenn、ブログへのリンクを掲載しています。`;

let blogItems: RssItem[] = [];
let zennItems: RssItem[] = [];
let blogError = false;
let zennError = false;

try {
  blogItems = sortByDate(await fetchRss(RSS_SOURCES.blog, 'Blog')).slice(0, 4);
} catch {
  blogError = true;
}

try {
  zennItems = sortByDate(await fetchRss(RSS_SOURCES.zenn, 'Zenn')).slice(0, 4);
} catch {
  zennError = true;
}

const formatDate = (value: string) =>
  Number.isNaN(new Date(value).getTime()) ? '-' : new Date(value).toLocaleDateString('ja-JP');
---

<!doctype html>
<html lang="ja">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
  </head>
  <body>
    <main class="grid">
      <header class="hero">
        <div class="hero-top">
          <img class="avatar" src="/pro.JPG" alt={`${PROFILE.name} profile`} width="96" height="96" />
          <div>
            <p class="eyebrow">Portfolio</p>
            <h1>{PROFILE.name}</h1>
            <p class="muted">{PROFILE.role}</p>
          </div>
        </div>
        <p>{PROFILE.bio}</p>
        <div class="tag-row">
          {PROFILE.stacks.map((stack) => <span class="tag">{stack}</span>)}
        </div>
      </header>

      <section class="card">
        <h2>Links</h2>
        <ul class="clean">
          <li><a class="link-item" href={LINKS.blog}><SocialIcon type="blog" />Blog (blog.hirovodka.com)</a></li>
          <li><a class="link-item" href={LINKS.github}><SocialIcon type="github" />GitHub</a></li>
          <li><a class="link-item" href={LINKS.x}><SocialIcon type="x" />X</a></li>
          <li><a class="link-item" href={LINKS.zenn}><SocialIcon type="zenn" />Zenn</a></li>
          <li><a class="link-item" href={LINKS.linkedin}><SocialIcon type="linkedin" />LinkedIn</a></li>
          <li><a class="link-item" href="/README/"><SocialIcon type="readme" />README / 職務経歴</a></li>
        </ul>
      </section>

      <section class="grid two">
        <article class="card">
          <h2>最近の投稿（Blog）</h2>
          {
            blogError ? (
              <p class="muted">Blog RSS を取得できませんでした。</p>
            ) : (
              <ul class="clean">
                {blogItems.map((item) => (
                  <li>
                    <a class="link-item" href={item.link}>{item.title}</a>
                    <div class="list-date">{formatDate(item.pubDate)}</div>
                  </li>
                ))}
              </ul>
            )
          }
        </article>

        <article class="card">
          <h2>最近の投稿（Zenn）</h2>
          {
            zennError ? (
              <p class="muted">Zenn RSS を取得できませんでした。</p>
            ) : (
              <ul class="clean">
                {zennItems.map((item) => (
                  <li>
                    <a class="link-item" href={item.link}>{item.title}</a>
                    <div class="list-date">{formatDate(item.pubDate)}</div>
                  </li>
                ))}
              </ul>
            )
          }
        </article>
      </section>
    </main>
  </body>
</html>
