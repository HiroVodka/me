---
import BaseHead from '../components/BaseHead.astro';
import { fetchRss, sortByDate, type RssItem } from '../lib/rss';
import { LINKS, PROFILE, RSS_SOURCES } from '../site.config';

const pageTitle = `${PROFILE.name} | ${PROFILE.role}`;
const pageDescription = `${PROFILE.bio} GitHubやZenn、ブログへのリンクを掲載しています。`;

let blogItems: RssItem[] = [];
let zennItems: RssItem[] = [];
let blogError = false;
let zennError = false;

try {
  blogItems = sortByDate(await fetchRss(RSS_SOURCES.blog, 'Blog')).slice(0, 4);
} catch {
  blogError = true;
}

try {
  zennItems = sortByDate(await fetchRss(RSS_SOURCES.zenn, 'Zenn')).slice(0, 4);
} catch {
  zennError = true;
}

const formatDate = (value: string) =>
  Number.isNaN(new Date(value).getTime()) ? '-' : new Date(value).toLocaleDateString('ja-JP');
---

<!doctype html>
<html lang="ja">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
  </head>
  <body>
    <main class="grid">
      <header class="card">
        <h1>{PROFILE.name}</h1>
        <p class="muted">{PROFILE.role}</p>
        <p>{PROFILE.bio}</p>
        <div>
          {PROFILE.stacks.map((stack) => <span class="tag">{stack}</span>)}
        </div>
      </header>

      <section class="card">
        <h2>Links</h2>
        <ul class="clean">
          <li><a href={LINKS.blog}>Blog (blog.hirovodka.com)</a></li>
          <li><a href={LINKS.github}>GitHub</a></li>
          <li><a href={LINKS.x}>X</a></li>
          <li><a href={LINKS.zenn}>Zenn</a></li>
          <li><a href={LINKS.qiita}>Qiita</a></li>
          <li><a href={LINKS.linkedin}>LinkedIn</a></li>
          <li><a href="/README/">README / 職務経歴</a></li>
        </ul>
      </section>

      <section class="grid two">
        <article class="card">
          <h2>最近の投稿（Blog）</h2>
          {
            blogError ? (
              <p class="muted">Blog RSS を取得できませんでした。</p>
            ) : (
              <ul class="clean">
                {blogItems.map((item) => (
                  <li>
                    <a href={item.link}>{item.title}</a>
                    <div class="muted">{formatDate(item.pubDate)}</div>
                  </li>
                ))}
              </ul>
            )
          }
        </article>

        <article class="card">
          <h2>最近の投稿（Zenn）</h2>
          {
            zennError ? (
              <p class="muted">Zenn RSS を取得できませんでした。</p>
            ) : (
              <ul class="clean">
                {zennItems.map((item) => (
                  <li>
                    <a href={item.link}>{item.title}</a>
                    <div class="muted">{formatDate(item.pubDate)}</div>
                  </li>
                ))}
              </ul>
            )
          }
        </article>
      </section>
    </main>
  </body>
</html>
